[32mINFO    [0m pytest_operator.plugin:plugin.py:806 Connecting to existing model github-pr-3f41a-microk8s:testing on unspecified cloud
[32mINFO    [0m juju.model:model.py:2098 Deploying local:repo-policy-compliance-0
[32mINFO    [0m juju.model:model.py:2098 Deploying ch:amd64/jammy/postgresql-k8s-684
[32mINFO    [0m juju.model:model.py:2972 Waiting for model:
  repo-policy-compliance/0 [allocating] waiting: installing agent
  repo-policy-compliance/1 [allocating] waiting: installing agent
  postgresql-k8s/0 [allocating] waiting: installing agent
[32mINFO    [0m juju.model:model.py:2972 Waiting for model:
  repo-policy-compliance/0 [idle] blocked: missing integrations: postgresql
  repo-policy-compliance/1 [idle] blocked: missing integrations: postgresql
  postgresql-k8s/0 [executing] maintenance: installing charm software
[32mINFO    [0m juju.model:model.py:2972 Waiting for model:
  repo-policy-compliance/0 [idle] blocked: missing integrations: postgresql
  repo-policy-compliance/1 [idle] blocked: missing integrations: postgresql
  postgresql-k8s/0 [executing] waiting: awaiting for cluster to start
[32mINFO    [0m juju.model:model.py:2972 Waiting for model:
  repo-policy-compliance/0 [idle] blocked: database migration command ['bash', '-eo', 'pipefail', 'migrate.sh'] failed, will retry in next update-status
  repo-policy-compliance/1 [idle] active: 
  postgresql-k8s/0 [idle] active: Primary
[32mINFO    [0m juju.model:model.py:2972 Waiting for model:
  repo-policy-compliance/0 [idle] blocked: database migration command ['bash', '-eo', 'pipefail', 'migrate.sh'] failed, will retry in next update-status
  repo-policy-compliance/1 [idle] active: 
  postgresql-k8s/0 [idle] active: Primary
[32mINFO    [0m juju.model:model.py:2972 Waiting for model:
  repo-policy-compliance/0 [idle] blocked: database migration command ['bash', '-eo', 'pipefail', 'migrate.sh'] failed, will retry in next update-status
  repo-policy-compliance/1 [idle] active: 
[32mINFO    [0m juju.model:model.py:2972 Waiting for model:
  repo-policy-compliance/0 [idle] blocked: database migration command ['bash', '-eo', 'pipefail', 'migrate.sh'] failed, will retry in next update-status
  repo-policy-compliance/1 [idle] active: 
[32mINFO    [0m juju.model:model.py:2972 Waiting for model:
  repo-policy-compliance/0 [idle] blocked: database migration command ['bash', '-eo', 'pipefail', 'migrate.sh'] failed, will retry in next update-status
  repo-policy-compliance/1 [idle] active: 
[32mINFO    [0m juju.model:model.py:2972 Waiting for model:
  repo-policy-compliance/0 [idle] blocked: database migration command ['bash', '-eo', 'pipefail', 'migrate.sh'] failed, will retry in next update-status
  repo-policy-compliance/1 [idle] active: 
[32mINFO    [0m juju.model:model.py:2972 Waiting for model:
  repo-policy-compliance/0 [idle] blocked: database migration command ['bash', '-eo', 'pipefail', 'migrate.sh'] failed, will retry in next update-status
  repo-policy-compliance/1 [idle] active: 
[32mINFO    [0m juju.model:model.py:2972 Waiting for model:
  repo-policy-compliance/0 [idle] blocked: database migration command ['bash', '-eo', 'pipefail', 'migrate.sh'] failed, will retry in next update-status
  repo-policy-compliance/1 [idle] active: 
[32mINFO    [0m juju.model:model.py:2972 Waiting for model:
  repo-policy-compliance/0 [idle] blocked: database migration command ['bash', '-eo', 'pipefail', 'migrate.sh'] failed, will retry in next update-status
  repo-policy-compliance/1 [idle] active: 
[32mINFO    [0m juju.model:model.py:2972 Waiting for model:
  repo-policy-compliance/0 [idle] maintenance: Preparing service for restart
  repo-policy-compliance/1 [idle] active:
[32mINFO    [0m pytest_operator.plugin:plugin.py:951 Model status:

Model    Controller                Cloud/Region        Version  SLA          Timestamp
testing  github-pr-3f41a-microk8s  microk8s/localhost  3.5.7    unsupported  19:02:49Z

App                     Version  Status  Scale  Charm                   Channel  Rev  Address         Exposed  Message
postgresql-k8s          14.19    active      1  postgresql-k8s          14/edge  684  10.152.183.205  no       
repo-policy-compliance           active      2  repo-policy-compliance             0  10.152.183.237  no       

Unit                       Workload  Agent  Address       Ports  Message
postgresql-k8s/0*          active    idle   10.1.108.140         Primary
repo-policy-compliance/0   active    idle   10.1.108.137         
repo-policy-compliance/1*  active    idle   10.1.108.138         

[32mINFO    [0m pytest_operator.plugin:plugin.py:957 Juju error logs:

unit-repo-policy-compliance-0: 18:57:49 ERROR unit.repo-policy-compliance/0.juju-log postgresql:4: database migration command ['bash', '-eo', 'pipefail', 'migrate.sh'] failed, stdout: , stderr: INFO  [alembic.runtime.migration] Context impl PostgresqlImpl.
INFO  [alembic.runtime.migration] Will assume transactional DDL.
Traceback (most recent call last):
  File "/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "/lib/python3.12/site-packages/sqlalchemy/engine/default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
psycopg2.errors.UniqueViolation: duplicate key value violates unique constraint "pg_type_typname_nsp_index"
DETAIL:  Key (typname, typnamespace)=(alembic_version, 2200) already exists.


The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/usr/bin/alembic", line 8, in <module>
    sys.exit(main())
             ^^^^^^
  File "/lib/python3.12/site-packages/alembic/config.py", line 1033, in main
    CommandLine(prog=prog).main(argv=argv)
  File "/lib/python3.12/site-packages/alembic/config.py", line 1023, in main
    self.run_cmd(cfg, options)
  File "/lib/python3.12/site-packages/alembic/config.py", line 957, in run_cmd
    fn(
  File "/lib/python3.12/site-packages/alembic/command.py", line 483, in upgrade
    script.run_env()
  File "/lib/python3.12/site-packages/alembic/script/base.py", line 545, in run_env
    util.load_python_file(self.dir, "env.py")
  File "/lib/python3.12/site-packages/alembic/util/pyfiles.py", line 116, in load_python_file
    module = load_module_py(module_id, path)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/lib/python3.12/site-packages/alembic/util/pyfiles.py", line 136, in load_module_py
    spec.loader.exec_module(module)  # type: ignore
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<frozen importlib._bootstrap_external>", line 995, in exec_module
  File "<frozen importlib._bootstrap>", line 488, in _call_with_frames_removed
  File "/flask/app/migrations/env.py", line 80, in <module>
    run_migrations_online()
  File "/flask/app/migrations/env.py", line 74, in run_migrations_online
    context.run_migrations()
  File "<string>", line 8, in run_migrations
  File "/lib/python3.12/site-packages/alembic/runtime/environment.py", line 946, in run_migrations
    self.get_context().run_migrations(**kw)
  File "/lib/python3.12/site-packages/alembic/runtime/migration.py", line 610, in run_migrations
    self._ensure_version_table()
  File "/lib/python3.12/site-packages/alembic/runtime/migration.py", line 548, in _ensure_version_table
    self._version.create(self.connection, checkfirst=True)
  File "/lib/python3.12/site-packages/sqlalchemy/sql/schema.py", line 1288, in create
    bind._run_ddl_visitor(ddl.SchemaGenerator, self, checkfirst=checkfirst)
  File "/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 2459, in _run_ddl_visitor
    ).traverse_single(element)
      ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/lib/python3.12/site-packages/sqlalchemy/sql/visitors.py", line 661, in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
  File "/lib/python3.12/site-packages/sqlalchemy/sql/ddl.py", line 1022, in visit_table
    )._invoke_with(self.connection)
      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/lib/python3.12/site-packages/sqlalchemy/sql/ddl.py", line 321, in _invoke_with
    return bind.execute(self)
           ^^^^^^^^^^^^^^^^^^
  File "/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1419, in execute
    return meth(
           ^^^^^
  File "/lib/python3.12/site-packages/sqlalchemy/sql/ddl.py", line 187, in _execute_on_connection
    return connection._execute_ddl(
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1530, in _execute_ddl
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 2355, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "/lib/python3.12/site-packages/sqlalchemy/engine/default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.IntegrityError: (psycopg2.errors.UniqueViolation) duplicate key value violates unique constraint "pg_type_typname_nsp_index"
DETAIL:  Key (typname, typnamespace)=(alembic_version, 2200) already exists.

[SQL: 
CREATE TABLE alembic_version (
	version_num VARCHAR(32) NOT NULL, 
	CONSTRAINT alembic_version_pkc PRIMARY KEY (version_num)
)

]
(Background on this error at: https://sqlalche.me/e/20/gkpj)


[32mINFO    [0m pytest_operator.plugin:plugin.py:1039 Forgetting model main...